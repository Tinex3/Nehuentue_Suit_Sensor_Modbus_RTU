/**
 * @file main.cpp
 * @brief Nehuentue Suit Sensor - Firmware v2.0 IntegraciÃ³n Progresiva
 * @version 2.0.0
 * @date 2025-10-19
 * 
 * NOTA: IntegraciÃ³n progresiva - Fase 1
 * - âœ… SystemManager integrado
 * - âœ… FlashStorageManager integrado  
 * - âœ… ModbusManager integrado
 * - â³ WiFiManager (pendiente - usa cÃ³digo legacy)
 * - â³ MQTTManager (pendiente - usa cÃ³digo legacy)
 */

#include <Arduino.h>
#include <AsyncElegantOTA.h>

// Managers integrados (sin conflictos)
#include <SystemManager.h>
#include <FlashStorageManager.h>
#include <ModbusManager.h>

// CÃ³digo legacy (temporal)
#include "config.h"
#include "modbus_rtu.h"  // Legacy - serÃ¡ reemplazado por ModbusManager en tasks
#include "tasks.h"
#include "web_server.h"

// ============================================================================
// SETUP
// ============================================================================

void setup() {
  Serial.begin(115200);
  delay(500);
  
  Serial.println("\n\n");
  Serial.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘                                              â•‘");
  Serial.println("â•‘   Nehuentue Suit Sensor v2.0                 â•‘");
  Serial.println("â•‘   IntegraciÃ³n Fase 1 - Managers BÃ¡sicos      â•‘");
  Serial.println("â•‘                                              â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println();
  
  // ========================================================================
  // 1. System Manager
  // ========================================================================
  Serial.println("[INIT] System Manager...");
  SysMgr.begin();
  SysMgr.printInfo();
  
  // ========================================================================
  // 2. Flash Storage Manager
  // ========================================================================
  Serial.println("[INIT] Flash Storage Manager...");
  if (FlashStorage.begin("nehuentue")) {
    Serial.println("[INIT] âœ“ Flash Storage inicializado");
    
    // Cargar configuraciÃ³n del sensor
    if (FlashStorage.load("sensor_config", sensorConfig)) {
      Serial.printf("[CONFIG] Sensor: '%s' (ID:%d, Start:%d, Qty:%d)\n",
                    sensorConfig.name,
                    sensorConfig.slaveId,
                    sensorConfig.startAddress,
                    sensorConfig.quantity);
    } else {
      Serial.println("[CONFIG] Sensor: usando valores por defecto");
    }
  } else {
    Serial.println("[WARN] Flash Storage no disponible - usando valores por defecto");
  }
  
  // ========================================================================
  // 3. Modbus Manager (nuevo)
  // ========================================================================
  Serial.println("[INIT] Modbus Manager...");
  ModbusMgr.begin(Serial1, sensorConfig.rxPin, sensorConfig.txPin, sensorConfig.baudrate);
  Serial.println("[INIT] âœ“ Modbus RTU Master inicializado");
  
  // ========================================================================
  // 4. InicializaciÃ³n legacy (WiFi, MQTT, Tasks)
  // ========================================================================
  Serial.println("[INIT] MÃ³dulos legacy...");
  
  // Modbus RTU legacy (para compatibilidad con tasks)
  modbusRTUInit(sensorConfig.rxPin, sensorConfig.txPin, sensorConfig.baudrate);
  
  // Tasks FreeRTOS
  initTasks();
  vTaskDelay(pdMS_TO_TICKS(300));
  
  // Web Server
  Serial.println("[INIT] Servidor web...");
  initWebServer();
  
  // OTA
  AsyncElegantOTA.begin(&webServer);
  Serial.println("[INIT] âœ“ OTA habilitado");
  
  // WiFi (legacy)
  if (WiFi.status() == WL_CONNECTED) {
    startSTAMode();
  } else {
    Serial.println("[WiFi] Iniciando modo AP");
    startAPMode();
  }
  
  // ========================================================================
  // Sistema listo
  // ========================================================================
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘                                              â•‘");
  Serial.println("â•‘  âœ… SISTEMA INICIADO                         â•‘");
  Serial.println("â•‘                                              â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  SysMgr.printStatus();
}

// ============================================================================
// LOOP
// ============================================================================

void loop() {
  // Managers
  SysMgr.loop();
  
  // OTA
  AsyncElegantOTA.loop();
  
  // EstadÃ­sticas periÃ³dicas
  static unsigned long lastStats = 0;
  if (millis() - lastStats > 60000) {  // Cada 60 segundos
    lastStats = millis();
    
    Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Serial.println("â•‘  ğŸ“Š ESTADÃSTICAS                               â•‘");
    Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    
    // Sistema
    SystemStatus status = SysMgr.getStatus();
    Serial.printf("  Uptime: %lu s  |  Heap: %lu bytes\n",
                  status.uptime / 1000, status.freeHeap);
    Serial.printf("  WiFi: %s  |  MQTT: %s\n",
                  status.wifiConnected ? "âœ“" : "âœ—",
                  status.mqttConnected ? "âœ“" : "âœ—");
    
    // Modbus
    ModbusMgr.printStats();
    
    // Datos del sensor (desde tasks legacy)
    if (dataMutex != NULL && xSemaphoreTake(dataMutex, pdMS_TO_TICKS(100)) == pdTRUE) {
      if (sensorData.valid && sensorData.registerCount > 0) {
        Serial.printf("  Sensor: %d registros vÃ¡lidos (Ãºltimo: hace %lu ms)\n",
                      sensorData.registerCount,
                      millis() - sensorData.timestamp);
        if (sensorData.registerCount > 0) {
          Serial.printf("    Reg[0] = %d (0x%04X)\n",
                        sensorData.registers[0], sensorData.registers[0]);
        }
      } else {
        Serial.println("  âš  Sin datos del sensor");
      }
      xSemaphoreGive(dataMutex);
    }
    
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  }
  
  delay(100);
}
